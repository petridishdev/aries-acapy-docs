"use strict";(self.webpackChunkaries_cloud_agent_python_documentation=self.webpackChunkaries_cloud_agent_python_documentation||[]).push([[893],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),m=o,d=u["".concat(s,".").concat(m)]||u[m]||h[m]||i;return n?a.createElement(d,r(r({ref:t},c),{},{components:n})):a.createElement(d,r({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},4848:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(7462),o=(n(7294),n(3905));const i={},r="Aries Routing - an example",l={unversionedId:"developer/AriesRoutingExample",id:"developer/AriesRoutingExample",title:"Aries Routing - an example",description:"In this example, we'll walk through an example of complex routing in Aries, outlining some of the possibilities that can be implemented.",source:"@site/docs/developer/AriesRoutingExample.md",sourceDirName:"developer",slug:"/developer/AriesRoutingExample",permalink:"/aries-acapy-docs/developer/AriesRoutingExample",draft:!1,editUrl:"https://github.com/hyperledger/aries-acapy-docs/tree/main/docs/docusaurus/docs/developer/AriesRoutingExample.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"An overview of Aries messaging",permalink:"/aries-acapy-docs/developer/AriesMessaging"},next:{title:"Connecting to an Indy Network",permalink:"/aries-acapy-docs/developer/ConnectIndyNetwork"}},s={},p=[{value:"The Scenario",id:"the-scenario",level:2},{value:"All the DIDs",id:"all-the-dids",level:2},{value:"DIDDoc Data",id:"diddoc-data",level:2},{value:"Preparing Bob&#39;s DIDDoc for Alice",id:"preparing-bobs-diddoc-for-alice",level:2}],c={toc:p},u="wrapper";function h(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"aries-routing---an-example"},"Aries Routing - an example"),(0,o.kt)("p",null,"In this example, we'll walk through an example of complex routing in Aries, outlining some of the possibilities that can be implemented."),(0,o.kt)("p",null,"We'll start with the Alice and Bob example from the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/hyperledger/aries-rfcs/blob/master/concepts/0094-cross-domain-messaging"},"Cross Domain Messaging")," Aries RFC."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://github.com/hyperledger/aries-rfcs/blob/master/concepts/0094-cross-domain-messaging/domains.jpg",alt:"Cross Domain Messaging Example",title:"Cross Domain Messaging Example"})),(0,o.kt)("p",null,"What are the DIDs involved, what's in their DIDDocs, and what communications are happening between the agents as the connections are made?"),(0,o.kt)("h2",{id:"the-scenario"},"The Scenario"),(0,o.kt)("p",null,'Bob and Alice want to establish a connection so that they can communicate. Bob uses an Agency endpoint ("',(0,o.kt)("a",{parentName:"p",href:"https://agents-r-us.com"},"https://agents-r-us.com"),"), labelled as 9 and will have an agent used for routing, labelled as 3. We'll also focus on Bob's messages from his main iPhone, labelled as 4.  We'll ignore Bob's other agents (5 and 6) and we won't worry about Alice's configuration (agents 1, 2 and 8). While the process below is all about Bob, Alice and her agents are doing the same interactions within her domain."),(0,o.kt)("h2",{id:"all-the-dids"},"All the DIDs"),(0,o.kt)("p",null,"A DID and DIDDoc are generated by each participant in each relationship. For Bob's agents (iPhone and Routing), that includes:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Bob and Alice"),(0,o.kt)("li",{parentName:"ul"},"Bob and his Routing Agent"),(0,o.kt)("li",{parentName:"ul"},"Bob and Agency"),(0,o.kt)("li",{parentName:"ul"},"Bob's Routing Agent and Agency")),(0,o.kt)("p",null,"That's a lot more than just the Bob and Alice relationship we usually think about!"),(0,o.kt)("h2",{id:"diddoc-data"},"DIDDoc Data"),(0,o.kt)("p",null,"From a routing perspective the important information in the DIDDoc is the following (as defined in the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/hyperledger/aries-rfcs/blob/master/features/0067-didcomm-diddoc-conventions/README.md"},"DIDDoc Conventions Aries RFC"),"):"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The public keys for agents referenced in the routing"),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"services")," of type ",(0,o.kt)("inlineCode",{parentName:"li"},"did-communication"),", including:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"the one ",(0,o.kt)("inlineCode",{parentName:"li"},"serviceEndpoint")),(0,o.kt)("li",{parentName:"ul"},"the ",(0,o.kt)("inlineCode",{parentName:"li"},"recipientKeys")," array of referenced keys for the ultimate target(s) of the message"),(0,o.kt)("li",{parentName:"ul"},"the ",(0,o.kt)("inlineCode",{parentName:"li"},"routingKeys")," array of referenced keys for the mediators")))),(0,o.kt)("p",null,"Let's look at the ",(0,o.kt)("inlineCode",{parentName:"p"},"did-communication")," service data in the DIDDocs generated by Bob's iPhone and Routing agents, listed above:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Bob and Alice:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"serviceEndpoint")," that Bob tells Alice about is the endpoint for the Agency."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"We'll use for the endpoint the Agency's public DID. That way the Agency can change rotate the keys for the endpoint without all of its clients from having to update every DIDDoc with the new key."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"recipientKeys")," entry is a key reference for Bob's iPhone specifically for Alice.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"routingKeys")," entries is a reference to the public key for the Routing Agent.")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Bob and his Routing Agent:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"serviceEndpoint")," is empty because Bob's iPhone has no endpoint. See the note below for more on this."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"recipientKeys")," entry is a key reference for Bob's iPhone specifically for the Routing Agent."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"routingKeys")," array is empty."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Bob and Agency:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"serviceEndpoint")," is the endpoint for Bob's Routing Agent."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"recipientKeys")," entry is a key reference for Bob's iPhone specifically for the Agency."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"routingKeys")," is a single entry for the key reference for the Routing Agent key."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Bob's Routing Agent and Agency:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"serviceEndpoint")," is the endpoint for Bob's Routing Agent."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"recipientKeys")," entry is a key reference for Bob's Routing Agent specifically for the Agency."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"routingKeys")," array is empty.")))),(0,o.kt)("p",null,"The null ",(0,o.kt)("inlineCode",{parentName:"p"},"serviceEndpoint")," for Bob's iPhone is worth a comment. Mobile apps work by sending requests to servers, but cannot be accessed directly from a server. A DIDComm mechanism (",(0,o.kt)("a",{parentName:"p",href:"https://github.com/hyperledger/aries-rfcs/tree/master/features/0092-transport-return-route"},"Transports Return Route"),") enables a server to send messages to a Mobile agent by putting the messages into the response to a request from the mobile agent. While not formalized in an Aries RFC (yet), cloud agents can use mobile platforms' (Apple and Google) notification mechanisms to trigger a user interface event."),(0,o.kt)("h2",{id:"preparing-bobs-diddoc-for-alice"},"Preparing Bob's DIDDoc for Alice"),(0,o.kt)("p",null,"Given that background, let's go through the sequence of events and messages that occur in building a DIDDoc for Bob's edge agent to send to Alice's edge agent. We'll start the sequence with all of the Agents in place as the bootstrapping of the Agency, Routing Agent and Bob's iPhone is trickier than we need to go through here. We'll call that an \"exercise left for the reader\"."),(0,o.kt)("p",null,"We'll start the process with Alice sending an out of band connection invitation message to Bob, e.g. through a QR code or a link in an email. Here's one possible sequence for creating the DIDDoc. Note that there are other ways this could be done:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Bob's iPhone agent generates a new DID for Alice and prepares, and partially completes, a DIDDoc"),(0,o.kt)("li",{parentName:"ul"},"Bob messages the Routing Agent to send the newly created DID and to get a new public key for the Alice relationship.",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"The Routing Agent records the DID for Alice and the keypair to be used for messages from Alice."))),(0,o.kt)("li",{parentName:"ul"},"The Routing Agent sends the DID to the Agency to let the Agency know that messages for the new DID are to go to the Routing Agent."),(0,o.kt)("li",{parentName:"ul"},"The Routing Agent sends the data to Bob's iPhone agent."),(0,o.kt)("li",{parentName:"ul"},"Bob's iPhone agent fills in the rest of the DIDDoc:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"the public key for the Routing Agent for the Alice relationship"),(0,o.kt)("li",{parentName:"ul"},"the ",(0,o.kt)("inlineCode",{parentName:"li"},"did-communication")," service endpoint is set to the Agency public DID and "),(0,o.kt)("li",{parentName:"ul"},"the routing keys array with the values of the Agency public DID key reference and the Routing Agent key reference")))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": Instead of using the DID Bob created, the Agency and Routing Agent might use the public key used to encrypt the messages for their internal routing table look up for where to send a message. In that case, the Bob and the Routing Agent share the public key instead of the DID to their respective upstream routers."),(0,o.kt)("p",null,"With the DIDDoc ready, Bob uses the path provided in the invitation to send a ",(0,o.kt)("inlineCode",{parentName:"p"},"connection-request")," message to Alice with the new DID and DIDDoc. Alice now knows how to get any DIDComm message to Bob in a secure, end-to-end encrypted manner. Subsequently, when Alice sends messages to Bob's agent, she uses the information in the DIDDoc to securely send the message to the Agency endpoint, it is sent through to the Routing Agent and on to Bob's iPhone agent for processing. Now Bob has the information he needs to securely send any DIDComm message to Alice in a secure, end-to-end encrypted manner."),(0,o.kt)("p",null,"At this time, there are ",(0,o.kt)("strong",{parentName:"p"},"not")," specific DIDComm protocols for the \"set up the routing\" messages between the agents in Bob's domain (Agency, Routing and iPhone). Those could be implemented to be proprietary by each agent provider (since it's possible one vendor would write the code for each of those agents), but it's likely those will be specified as open standard DIDComm protocols."),(0,o.kt)("p",null,"Based on the DIDDoc that Bob has sent Alice, for her to send a DIDComm message to Bob, Alice must:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Prepare the message for Bob's Agent."),(0,o.kt)("li",{parentName:"ul"},'Encrypt and place that message into a "Forward" message for Bob\'s Routing Agent.'),(0,o.kt)("li",{parentName:"ul"},'Encrypt and send the "Forward" message to Bob\'s Agency endpoint.')))}h.isMDXComponent=!0}}]);