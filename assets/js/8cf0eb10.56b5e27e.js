"use strict";(self.webpackChunkaries_cloud_agent_python_documentation=self.webpackChunkaries_cloud_agent_python_documentation||[]).push([[2170],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>h});var o=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=o.createContext({}),c=function(e){var n=o.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=c(e.components);return o.createElement(s.Provider,{value:n},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},u=o.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=c(t),u=r,h=p["".concat(s,".").concat(u)]||p[u]||m[u]||a;return t?o.createElement(h,i(i({ref:n},d),{},{components:t})):o.createElement(h,i({ref:n},d))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,i=new Array(a);i[0]=u;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[p]="string"==typeof e?e:r,i[1]=l;for(var c=2;c<a;c++)i[c]=t[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},2541:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var o=t(7462),r=(t(7294),t(3905));const a={},i="Acme Controller Workshop",l={unversionedId:"demo/AcmeDemoWorkshop",id:"demo/AcmeDemoWorkshop",title:"Acme Controller Workshop",description:"In this workshop we will add some functionality to a third participant in the Alice/Faber drama - namely, Acme Inc.  After completing her education at Faber College, Alice is going to apply for a job at Acme Inc.  To do this she must provide proof of education (once she has completed the interview and other non-Indy tasks), and then Acme will issue her an employment credential.",source:"@site/docs/demo/AcmeDemoWorkshop.md",sourceDirName:"demo",slug:"/demo/AcmeDemoWorkshop",permalink:"/aries-acapy-docs/demo/AcmeDemoWorkshop",draft:!1,editUrl:"https://github.com/hyperledger/aries-acapy-docs/tree/main/docs/docusaurus/docs/demo/AcmeDemoWorkshop.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Aries Cloud Agent Python (ACA-Py) Demos",permalink:"/aries-acapy-docs/demo/"},next:{title:"Using Tracing in ACA-PY",permalink:"/aries-acapy-docs/demo/AgentTracing"}},s={},c=[{value:"Preview of the Acme Controller",id:"preview-of-the-acme-controller",level:2},{value:"Asking Alice for a Proof of Education",id:"asking-alice-for-a-proof-of-education",level:2},{value:"Issuing Alice a Work Credential",id:"issuing-alice-a-work-credential",level:2}],d={toc:c},p="wrapper";function m(e){let{components:n,...t}=e;return(0,r.kt)(p,(0,o.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"acme-controller-workshop"},"Acme Controller Workshop"),(0,r.kt)("p",null,"In this workshop we will add some functionality to a third participant in the Alice/Faber drama - namely, Acme Inc.  After completing her education at Faber College, Alice is going to apply for a job at Acme Inc.  To do this she must provide proof of education (once she has completed the interview and other non-Indy tasks), and then Acme will issue her an employment credential."),(0,r.kt)("p",null,"Note that an updated Acme controller is available here: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ianco/aries-cloudagent-python/tree/acme_workshop/demo"},"https://github.com/ianco/aries-cloudagent-python/tree/acme_workshop/demo")," if you just want to skip ahead ...  There is also an alternate solution with some additional functionality available here:  ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ianco/aries-cloudagent-python/tree/agent_workshop/demo"},"https://github.com/ianco/aries-cloudagent-python/tree/agent_workshop/demo")),(0,r.kt)("h2",{id:"preview-of-the-acme-controller"},"Preview of the Acme Controller"),(0,r.kt)("p",null,"There is already a skeleton of the Acme controller in place, you can run it as follows.  (Note that beyond establishing a connection it doesn't actually do anything yet.)"),(0,r.kt)("p",null,"To run the Acme controller template, first run Alice and Faber so that Alice can prove her education experience:"),(0,r.kt)("p",null,"Open 2 bash shells, and in each run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/hyperledger/aries-cloudagent-python.git\ncd aries-cloudagent-python/demo\n")),(0,r.kt)("p",null,"In one shell run Faber:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"LEDGER_URL=http://dev.greenlight.bcovrin.vonx.io ./run_demo faber\n")),(0,r.kt)("p",null,"... and in the second shell run Alice:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"LEDGER_URL=http://dev.greenlight.bcovrin.vonx.io ./run_demo alice\n")),(0,r.kt)("p",null,"When Faber has produced an invitation, copy it over to Alice."),(0,r.kt)("p",null,"Then, in the Faber shell, select option ",(0,r.kt)("inlineCode",{parentName:"p"},"1")," to issue a credential to Alice.  (You can select option ",(0,r.kt)("inlineCode",{parentName:"p"},"2")," if you like, to confirm via proof.)"),(0,r.kt)("p",null,"Then, in the Faber shell, enter ",(0,r.kt)("inlineCode",{parentName:"p"},"X")," to exit the controller, and then run the Acme controller:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"LEDGER_URL=http://dev.greenlight.bcovrin.vonx.io ./run_demo acme\n")),(0,r.kt)("p",null,"In the Alice shell, select option ",(0,r.kt)("inlineCode",{parentName:"p"},"4")," (to enter a new invitation) and then copy over Acme's invitation once it's available."),(0,r.kt)("p",null,"Then, in the Acme shell, you can select option ",(0,r.kt)("inlineCode",{parentName:"p"},"2")," and then option ",(0,r.kt)("inlineCode",{parentName:"p"},"1"),", which don't do anything ... yet!!!"),(0,r.kt)("h2",{id:"asking-alice-for-a-proof-of-education"},"Asking Alice for a Proof of Education"),(0,r.kt)("p",null,"In the Acme code ",(0,r.kt)("inlineCode",{parentName:"p"},"acme.py")," we are going to add code to issue a proof request to Alice, and then validate the received proof."),(0,r.kt)("p",null,"First the following import statements and constants that we will need near the top of acme.py:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import random\n\nfrom datetime import date\nfrom uuid import uuid4\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'TAILS_FILE_COUNT = int(os.getenv("TAILS_FILE_COUNT", 100))\nCRED_PREVIEW_TYPE = "https://didcomm.org/issue-credential/2.0/credential-preview"\n')),(0,r.kt)("p",null,"Next locate the code that is triggered by option ",(0,r.kt)("inlineCode",{parentName:"p"},"2"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'            elif option == "2":\n                log_status("#20 Request proof of degree from alice")\n                # TODO presentation requests\n')),(0,r.kt)("p",null,"Replace the ",(0,r.kt)("inlineCode",{parentName:"p"},"# TODO")," comment with the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'                req_attrs = [\n                    {\n                        "name": "name",\n                        "restrictions": [{"schema_name": "degree schema"}]\n                    },\n                    {\n                        "name": "date",\n                        "restrictions": [{"schema_name": "degree schema"}]\n                    },\n                    {\n                        "name": "degree",\n                        "restrictions": [{"schema_name": "degree schema"}]\n                    }\n                ]\n                req_preds = []\n                indy_proof_request = {\n                    "name": "Proof of Education",\n                    "version": "1.0",\n                    "nonce": str(uuid4().int),\n                    "requested_attributes": {\n                        f"0_{req_attr[\'name\']}_uuid": req_attr\n                        for req_attr in req_attrs\n                    },\n                    "requested_predicates": {}\n                }\n                proof_request_web_request = {\n                    "connection_id": agent.connection_id,\n                    "presentation_request": {"indy": indy_proof_request},\n                }\n                # this sends the request to our agent, which forwards it to Alice\n                # (based on the connection_id)\n                await agent.admin_POST(\n                    "/present-proof-2.0/send-request",\n                    proof_request_web_request\n                )\n')),(0,r.kt)("p",null,"Now we need to handle receipt of the proof.  Locate the code that handles received proofs (this is in a webhook callback):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'        if state == "presentation-received":\n            # TODO handle received presentations\n            pass\n')),(0,r.kt)("p",null,"then replace the ",(0,r.kt)("inlineCode",{parentName:"p"},"# TODO")," comment and the ",(0,r.kt)("inlineCode",{parentName:"p"},"pass")," statement:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'            log_status("#27 Process the proof provided by X")\n            log_status("#28 Check if proof is valid")\n            proof = await self.admin_POST(\n                f"/present-proof-2.0/records/{pres_ex_id}/verify-presentation"\n            )\n            self.log("Proof = ", proof["verified"])\n\n            # if presentation is a degree schema (proof of education),\n            # check values received\n            pres_req = message["by_format"]["pres_request"]["indy"]\n            pres = message["by_format"]["pres"]["indy"]\n            is_proof_of_education = (\n                pres_req["name"] == "Proof of Education"\n            )\n            if is_proof_of_education:\n                log_status("#28.1 Received proof of education, check claims")\n                for (referent, attr_spec) in pres_req["requested_attributes"].items():\n                    if referent in pres[\'requested_proof\'][\'revealed_attrs\']:\n                        self.log(\n                            f"{attr_spec[\'name\']}: "\n                            f"{pres[\'requested_proof\'][\'revealed_attrs\'][referent][\'raw\']}"\n                        )\n                    else:\n                        self.log(\n                            f"{attr_spec[\'name\']}: "\n                            "(attribute not revealed)"\n                        )\n                for id_spec in pres["identifiers"]:\n                    # just print out the schema/cred def id\'s of presented claims\n                    self.log(f"schema_id: {id_spec[\'schema_id\']}")\n                    self.log(f"cred_def_id {id_spec[\'cred_def_id\']}")\n                # TODO placeholder for the next step\n            else:\n                # in case there are any other kinds of proofs received\n                self.log("#28.1 Received ", pres_req["name"])\n')),(0,r.kt)("p",null,'Right now this just verifies the proof received and prints out the attributes it reveals, but in "real life" your application could do something useful with this information.'),(0,r.kt)("p",null,'Now you can run the Faber/Alice/Acme script from the "Preview of the Acme Controller" section above, and you should see Acme receive a proof from Alice!'),(0,r.kt)("h2",{id:"issuing-alice-a-work-credential"},"Issuing Alice a Work Credential"),(0,r.kt)("p",null,"Now we can issue a work credential to Alice!"),(0,r.kt)("p",null,"There are two options for this.  We can (a) add code under option ",(0,r.kt)("inlineCode",{parentName:"p"},"1")," to issue the credential, or (b) we can automatically issue this credential on receipt of the education proof."),(0,r.kt)("p",null,"We're going to do option (a), but you can try to implement option (b) as homework.  You have most of the information you need from the proof response!"),(0,r.kt)("p",null,"First though we need to register a schema and credential definition.  Find this code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'        # acme_schema_name = "employee id schema"\n        # acme_schema_attrs = ["employee_id", "name", "date", "position"]\n        await acme_agent.initialize(\n            the_agent=agent,\n            # schema_name=acme_schema_name,\n            # schema_attrs=acme_schema_attrs,\n        )\n\n        # TODO publish schema and cred def\n')),(0,r.kt)("p",null,"... and uncomment the code lines. Replace the ",(0,r.kt)("inlineCode",{parentName:"p"},"# TODO")," comment with the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'        with log_timer("Publish schema and cred def duration:"):\n            # define schema\n            version = format(\n                "%d.%d.%d"\n                % (\n                    random.randint(1, 101),\n                    random.randint(1, 101),\n                    random.randint(1, 101),\n                )\n            )\n            # register schema and cred def\n            (schema_id, cred_def_id) = await agent.register_schema_and_creddef(\n                "employee id schema",\n                version,\n                ["employee_id", "name", "date", "position"],\n                support_revocation=False,\n                revocation_registry_size=TAILS_FILE_COUNT,\n            )\n')),(0,r.kt)("p",null,"For option (1) we want to replace the ",(0,r.kt)("inlineCode",{parentName:"p"},"# TODO")," comment here:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'            elif option == "1":\n                log_status("#13 Issue credential offer to X")\n                # TODO credential offers\n')),(0,r.kt)("p",null,"with the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'                agent.cred_attrs[cred_def_id] = {\n                    "employee_id": "ACME0009",\n                    "name": "Alice Smith",\n                    "date": date.isoformat(date.today()),\n                    "position": "CEO"\n                }\n                cred_preview = {\n                    "@type": CRED_PREVIEW_TYPE,\n                    "attributes": [\n                        {"name": n, "value": v}\n                        for (n, v) in agent.cred_attrs[cred_def_id].items()\n                    ],\n                }\n                offer_request = {\n                    "connection_id": agent.connection_id,\n                    "comment": f"Offer on cred def id {cred_def_id}",\n                    "credential_preview": cred_preview,\n                    "filter": {"indy": {"cred_def_id": cred_def_id}},\n                }\n                await agent.admin_POST(\n                    "/issue-credential-2.0/send-offer", offer_request\n                )\n')),(0,r.kt)("p",null,"... and then locate the code that handles the credential request callback:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'        if state == "request-received":\n            # TODO issue credentials based on offer preview in cred ex record\n            pass\n')),(0,r.kt)("p",null,"... and replace the ",(0,r.kt)("inlineCode",{parentName:"p"},"# TODO")," comment and ",(0,r.kt)("inlineCode",{parentName:"p"},"pass")," statement with the following code to issue the credential as Acme offered it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'            # issue credentials based on offer preview in cred ex record\n            if not message.get("auto_issue"):\n                await self.admin_POST(\n                    f"/issue-credential-2.0/records/{cred_ex_id}/issue",\n                    {"comment": f"Issuing credential, exchange {cred_ex_id}"},\n                )\n')),(0,r.kt)("p",null,"Now you can run the Faber/Alice/Acme steps again.  You should be able to receive a proof and then issue a credential to Alice."))}m.isMDXComponent=!0}}]);